<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>新vps的一般初始化步骤 - PRELUDE</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='../style/basic_styles.css'>
    <link rel="stylesheet" href="https://unpkg.com/simpledotcss/simple.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src=https://www.googletagmanager.com/gtag/js?id=UA-92314993-3></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-92314993-3');
    </script>
</head>
<body>


    <div class="container">
    
        <div class="header-article">
    <p><a href="../index.html">PRELUDE</a></p>
</div>
    
    <div>
        <h1 class="page-title">新vps的一般初始化步骤</h1>
        


    

    
<p>
        
            
<span class=" default">以下所有操作均是在root账户下操作。</span>

        
    </p>
    

    
<h2>
        
            
<span class=" default">一、</span>

        
            
<span class=" bold default">更改ssh端口</span>

        
    </h2>
    

    
<pre><code class=language-bash>
vi /etc/ssh/sshd_config
</code></pre>
    

    
<p>
        
            
<span class=" default">把port这一行注释去掉，22改成你要的端口号。</span>

        
    </p>
    

    
<pre><code class=language-bash>
service sshd status
</code></pre>
    

    
<p>
        
            
<span class=" default">看一下是不是在监听指定端口号。</span>

        
    </p>
    

    
<h2>
        
            
<span class=" default">二、</span>

        
            
<span class=" bold default">更改密码</span>

        
    </h2>
    

    
<p>
        
            
<span class=" code default">passwd</span>

        
            
<span class=" default">命令敲进去，换密码。</span>

        
    </p>
    

    
<h2>
        
            
<span class=" default">三、</span>

        
            
<span class=" bold default">关掉firewalld</span>

        
    </h2>
    

    
<p>
        
            
<span class=" default">centos 7自带一个firewalld防火墙，用iptables就行了，firewalld用处不是很大。</span>

        
    </p>
    

    
<p>
        
            
<span class=" default">先看一下firewalld是不是开着的：</span>

        
    </p>
    

    
<pre><code class=language-bash>
firewall-cmd --state
</code></pre>
    

    
<p>
        
            
<span class=" default">如果是</span>

        
            
<span class=" code default">running</span>

        
            
<span class=" default">那就要先把服务关了：</span>

        
    </p>
    

    
<pre><code class=language-bash>
systemctl stop firewalld
</code></pre>
    

    
<p>
        
            
<span class=" default">再disable掉不要开机启动了：</span>

        
    </p>
    

    
<pre><code class=language-bash>
systemctl disable firewalld
systemctl mask firewalld
</code></pre>
    

    
<p>
        
            
<span class=" default">成了。</span>

        
    </p>
    

    
<h2>
        
            
<span class=" default">四、</span>

        
            
<span class=" bold default">升级内核</span>

        
    </h2>
    

    
<p>
        
            
<span class=" default">先</span>

        
            
<span class=" code default">yum update</span>

        
            
<span class=" default">一波，再导入ELRepo公钥</span>

        
    </p>
    

    
<pre><code class=language-bash>
rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
</code></pre>
    

    
<p>
        
            
<span class=" default">再安装ELRepo(注：我的是centos 7，其他版本</span>

        
            
<a href=http://elrepo.org/tiki/tiki-index.php class=" default">参考</a>

        
            
<span class=" default">)</span>

        
    </p>
    

    
<pre><code class=language-bash>
yum install https://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
</code></pre>
    

    
<p>
        
            
<span class=" default">然后直接安装最新主线内核</span>

        
    </p>
    

    
<pre><code class=language-bash>
yum --enablerepo=elrepo-kernel install kernel-ml
</code></pre>
    

    
<p>
        
            
<span class=" default">完成之后看一下新内核是不是装上去了</span>

        
    </p>
    

    
<pre><code class=language-bash>
sudo awk -F\\&#39; &#39;$1==&#34;menuentry &#34; {print i++ &#34; : &#34; $2}&#39; /etc/grub2.cfg
</code></pre>
    

    
<p>
        
            
<span class=" default">我的显示</span>

        
    </p>
    

    
<pre><code class=language-bash>
[root@test2 ~]# awk -F\\&#39; &#39;$1==&#34;menuentry &#34; {print i++ &#34; : &#34; $2}&#39; /etc/grub2.cfg
0 : CentOS Linux (5.1.3-1.el7.elrepo.x86_64) 7 (Core)
1 : CentOS Linux (3.10.0-957.12.2.el7.x86_64) 7 (Core)
2 : CentOS Linux (3.10.0-957.10.1.el7.x86_64) 7 (Core)
3 : CentOS Linux (3.10.0-693.el7.x86_64) 7 (Core)
4 : CentOS Linux (0-rescue-8508293106977c25a934808909d9e8a1) 7 (Core)
</code></pre>
    

    
<p>
        
            
<span class=" default">0就是新内核。保险起见再设置一下0为默认启动内核：</span>

        
    </p>
    

    
<pre><code class=language-bash>
grub2-set-default 0
</code></pre>
    

    
<p>
        
            
<span class=" default">最后生成grub2配置</span>

        
    </p>
    

    
<pre><code class=language-bash>
grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre>
    

    
<p>
        
            
<span class=" default">哦了，</span>

        
            
<span class=" code default">reboot</span>

        
            
<span class=" default">即可。</span>

        
    </p>
    

    
<p>
        
            
<span class=" default">重启完看一下</span>

        
            
<span class=" code default">uname -r</span>

        
            
<span class=" default">是不是用新内核了：</span>

        
    </p>
    

    
<pre><code class=language-bash>
[root@test2 ~]# uname -r
5.1.3-1.el7.elrepo.x86_64
</code></pre>
    

    
<p>
        
            
<span class=" default">成了。</span>

        
            
<a href=https://www.howtoforge.com/tutorial/how-to-upgrade-kernel-in-centos-7-server/ class=" default">参考</a>

        
    </p>
    

    
<h2>
        
            
<span class=" default">五、</span>

        
            
<span class=" bold default">开启bbr</span>

        
    </h2>
    

    
<p>
        
            
<span class=" default">先</span>

        
            
<span class=" code default">lsmod | grep bbr</span>

        
            
<span class=" default">看一下有没有返回结果，有就是开起来了。我是没开起来，所以：</span>

        
    </p>
    

    
<pre><code class=language-bash>
modprobe tcp_bbr
echo &#34;tcp_bbr&#34; | sudo tee --append /etc/modules-load.d/modules.conf
</code></pre>
    

    
<p>
        
            
<span class=" default">然后改一下配置文件：</span>

        
    </p>
    

    
<pre><code class=language-bash>
echo &#34;net.core.default_qdisc=fq&#34; | sudo tee --append /etc/sysctl.conf
echo &#34;net.ipv4.tcp_congestion_control=bbr&#34; | sudo tee --append /etc/sysctl.conf
</code></pre>
    

    
<p>
        
            
<span class=" default">保存一下配置</span>

        
    </p>
    

    
<pre><code class=language-bash>
sysctl -p
</code></pre>
    

    
<p>
        
            
<span class=" default">再</span>

        
            
<span class=" code default">lsmod | grep bbr</span>

        
            
<span class=" default">看一下，成了。</span>

        
            
<a href=https://github.com/iMeiji/shadowsocks_install/wiki/%E5%BC%80%E5%90%AF-TCP-BBR-%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6%E7%AE%97%E6%B3%95 class=" default">参考</a>

        
    </p>
    

    
<h2>
        
            
<span class=" default">六、</span>

        
            
<span class=" bold default">清空iptables规则</span>

        
    </h2>
    

    
<p>
        
            
<span class=" default">个人习惯把iptables清除一遍，再做配置。</span>

        
    </p>
    

    
<pre><code class=language-bash>
iptables -t nat -F  
iptables -t nat -X  
iptables -t nat -P PREROUTING ACCEPT  
iptables -t nat -P POSTROUTING ACCEPT  
iptables -t nat -P OUTPUT ACCEPT  
iptables -t mangle -F  
iptables -t mangle -X  
iptables -t mangle -P PREROUTING ACCEPT  
iptables -t mangle -P INPUT ACCEPT  
iptables -t mangle -P FORWARD ACCEPT  
iptables -t mangle -P OUTPUT ACCEPT  
iptables -t mangle -P POSTROUTING ACCEPT  
iptables -F  
iptables -X  
iptables -P FORWARD ACCEPT  
iptables -P INPUT ACCEPT  
iptables -P OUTPUT ACCEPT  
iptables -t raw -F  
iptables -t raw -X  
iptables -t raw -P PREROUTING ACCEPT  
iptables -t raw -P OUTPUT ACCEPT
</code></pre>
    

    
<p>
        
            
<span class=" default">再</span>

        
            
<span class=" code default">iptables-save</span>

        
            
<span class=" default">看一下配置是不是清除干净了。</span>

        
            
<a href=http://os.51cto.com/art/201103/249518.htm class=" default">参考</a>

        
    </p>
    

    
<p>
        
            
<span class=" default">之后再</span>

        
            
<span class=" code default">service iptables save</span>

        
            
<span class=" default">保存一下。如果出现：</span>

        
    </p>
    

    
<pre><code class=language-bash>
[root@test2 ~]# service iptables save
The service command supports only basic LSB actions (start, stop, restart, try-restart, reload, force-reload, status). For other actions, please try to use systemctl.
</code></pre>
    

    
<p>
        
            
<span class=" default">那就是系统的iptables没装好，再装一下：</span>

        
    </p>
    

    
<pre><code class=language-bash>
yum install iptables-services
</code></pre>
    

    
<p>
        
            
<span class=" default">再确保一下自启：</span>

        
    </p>
    

    
<pre><code class=language-bash>
systemctl enable iptables
systemctl start iptables
</code></pre>
    

    
<p>
        
            
<a href=https://stackoverflow.com/questions/24756240/how-can-i-use-iptables-on-centos-7 class=" default">参考</a>

        
    </p>
    

    
<p>
        
    </p>
    

    </div>
    <div class="footer">
    <p>Created by <a href="https://github.com/imyangmo/notionpaper">NotionPaper</a>, a tool that helps you use Notion like a CMS. </p>
    <p>This site uses <a href="https://simplecss.org/">Simple.css</a></p>
</div>

</div>
</body>
</html>